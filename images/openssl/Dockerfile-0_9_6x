FROM alpine-build as openssl
ARG VERSION
RUN wget -O openssl.tar.gz https://www.openssl.org/source/old/0.9.x/openssl-0.9.${VERSION}.tar.gz
RUN mkdir openssl
RUN tar -xzf openssl.tar.gz -C openssl --strip-components 1
WORKDIR /src/openssl
RUN mv Makefile.ssl tmp && sed "s/-m486/-m16/g" tmp > Makefile.ssl
RUN mv Makefile.org tmp && sed "s/-m486/-m16/g" tmp > Makefile.org
RUN mv Configure tmp && sed "s/-m486/-m16/g" tmp > Configure
COPY read_pwd_termios.patch ./
RUN patch crypto/des/read_pwd.c < read_pwd_termios.patch

RUN ./config --prefix=/build/ --openssldir=/build/ no-async no-asm -fPIC
RUN make && make install
#todo: fix error: "4-byte relocation cannot be applied to 2-byte field"

FROM scratch
ARG VERSION
LABEL "server_type"="openssl"
LABEL "server_version"="0.9.${VERSION}"
COPY --from=openssl /lib/ld-musl-x86_64.so.* \
  /usr/lib/libstdc++.so.* \
  /usr/lib/libgcc_s.so.* \
  /build/lib/*.so.* /lib/
COPY --from=openssl /build/bin/openssl /bin/
ENTRYPOINT ["openssl", "s_server"]
